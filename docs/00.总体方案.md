## 1. DApp 整体功能

1. 充值（deposit）：从用户钱包（MetaMask 等）充值到 RedotPay 业务合约地址
2. 提币（withdraw）：从 RedotPay 业务合约提币到用户钱包（MetaMask 等）
3. 余额显示

## 2. 前端

引导用户充值、提现，连接钱包、授权等

## 3. 后端服务

提供如下 API：

**注册**：

**KYC**：

**登录**：

**充值**：需监听链上 Deposit EVENT，当用户从钱包往合约里充值后，需往库里记账；

**提现**：往库里插入一条提现申请；

**获取资产余额**：

## 4. 自动化脚本

清算脚本：定期批量清算；

提现脚本：定期批量处理提现

## 5. 业务合约（链上）

| 角色            | 类型                        | 作用                                           | 备注                           |
| :-------------- | --------------------------- | ---------------------------------------------- | ------------------------------ |
| balances        | mapping(address => unit256) | 存储用户的账户余额                             | 初始化时放一个管理员的地址进去 |
| deposit         | function                    | 充值，让用户把钱从自己的钱包充值到合约里       | 给用户用                       |
| withdraw        | function                    | 提现，管理员把合约里的资产转到自己地址         |                                |
| withdraws       | function                    | 提现，管理员批量处理用户的提现                 | 2-Of-3 多签                    |
| settle          | function                    | 结算，减少用户的资产可用，增加管理员的资产可用 | 2-Of-3 多签                    |
| banlanceOf      | function                    | 获取某个用户的资产余额                         |                                |
| banlance        | function                    | 获取整个合约里的资产余额                       |                                |
| disableContract | function                    | 一键禁用所有合约方法                           | 2-Of-3 多签                    |
| enableContract  | function                    | 一键解禁所有合约方法                           | 2-Of-3 多签                    |
|                 |                             |                                                |                                |

## 6. 业务流程

用户 A 从 DApp 前端页面充币（假设 100U）到合约里，合约变量`balances`把用户的可用增加 100U；

用户 A 刷卡消费 10U，管理员在后台调用合约`settle`方法进行结算，把用户 A 的资产余额减少为 100-10=90U，管理员资产余额增加为 0+10=10U；

用户 A 发起提币请求，假设提币 90U。服务后台收到请求后，把用户 A 的卡片置为不可消费状态；并判断用户 A 有没有未完成或未结算的订单，如果有，则拒绝此笔提币请求；如果没有，管理员后台调用合约`withdraws`方法，批量给用户提现，提现完成后把用户 A 的卡片设置为可消费状态。

管理员后台调用合约`withdraw`方法把合约里的资产转移到自己的地址。

## 7. 要注意的点

`settle`、`withdraw`、`withdraws`等方法涉及记账和资产的实际转移，所以要多签

## 8. 风控考虑

当发生紧急情况需要风控时，管理员可以调用合约`disableContract`方法一键禁用其他合约方法（比如 withdraw、settle 等）。

当风控解除时，管理员可以调用合约`enableContract`方法一键解禁其他合约方法，使合约恢复正常服务状态。

## 9. 要讨论的问题

**问题一：**withdraw(把合约里的资金转移到自己的某个地址)，最好通过调用合约方法来实现，原因是：

1）能转走的资金并不是合约里的全部资金，而是用户消费并清算的部分，通过合约方法去转账能很好的做提前判断；

2）把资产转走的同时，需要减去管理员可用字段，此两个动作最好保持原子性（要成功都成功，要失败都失败），通过合约方法去转账能很好的保持原子性。

**问题二：**自动化脚本用 nodejs 编写会方便很多，原因：

1）交互合约的 js 版本 api 比较丰富，如 ethers.js，web3.js

2）智能合约的依赖管理也是用 npm，跟 js 生态有更好的适配性
